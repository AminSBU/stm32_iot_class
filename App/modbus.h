// 1402/09/18 => 12 December 2023 09:40 => Change 250 to 249 in Line 59
#ifndef __MODBUS_H
#define __MODBUS_H

// Modbus Protocol Reference Guide [EM-5650 Rev.10]
// https://www.modbustools.com/modbus.html#Function01

// PLC_Address = 00001:09999 => Coil Status
// PLC_Address = 10001:19999 => Discrete input (Input Status)
// PLC_Address = 40001:49999 => Holding Register
// PLC_Address = 30001:39999 => Input Register
// register_address = (PLC_address - 1) & 0xFFFF = 0:9998

#ifdef __cplusplus
extern "C" {
#endif

#include <stdint.h>
#include <stdbool.h>
#include <string.h>
#if defined(STM32H7)
#include "stm32h7xx_hal.h"
#endif
// <<< Use Configuration Wizard in Context Menu >>>
// <q> MODBUS_WITH_RTOS
#ifndef MODBUS_WITH_RTOS
#define MODBUS_WITH_RTOS            0
#endif
// <<< end of configuration section >>>

#define SWAP16(x)                   (((x >> 8) & 0x00FF) | ((x << 8) & 0xFF00))
#define MODBUS_WRITE_SINGLE_COIL(x) ((x == 0) 0x0000: 0xFF00)
#define MODBUS_REQ_RES_SIZE         255 // based on modbus protocol
#define MODBUS_MAX_DATA_SIZE        MODBUS_REQ_RES_SIZE // The valid size is below of this amount

typedef enum
{
    read_coils                      = 1,
    read_discrete_inputs            = 2, // or read_input_status
    read_holding_registers          = 3,
    read_input_registers            = 4,
    
    write_single_coil               = 5, // or force_single_coil
    write_single_holding_register   = 6, // or preset_single_register
    write_multiple_coils            = 15,
    write_multiple_registers        = 16,
    
    write_file_record               = 21 // 0x15 
} function_codes_t;

typedef enum
{
    MODBUS_RESULT_OK                   = 0,
    
    MODBUS_RESULT_ILLEGAL_FUNCTION     = 1, // Modbus Exception Codes
    MODBUS_RESULT_ILLEGAL_DATA_ADDRESS = 2, // Modbus Exception Codes
    MODBUS_RESULT_ILLEGAL_DATA_VALUE   = 3, // Modbus Exception Codes
    
    MODBUS_RESULT_TIMEOUT              = 249,
    MODBUS_RESULT_INVALID_REQ          = 250,
    MODBUS_RESULT_INVALID_RES          = 251,
    MODBUS_RESULT_INCOMPLETE_REQ       = 252,
    MODBUS_RESULT_INCOMPLETE_RES       = 253,
    MODBUS_RESULT_CRC_ERROR            = 254,
} modbus_result_t;

typedef struct
{
    struct
    {
        uint8_t                     slave_address;
        uint8_t                     function_code;
        //--- For most messages
        uint16_t                    first_register_address;
        uint16_t                    number_of_registers;
        uint16_t                    byte_count;
        //--- write_file_record, read_file_record
        uint8_t                     data_length;
        uint8_t                     reference_type;
        uint16_t                    file_number;
        uint16_t                    record_number;
        uint16_t                    record_length;
        //---------------------
        uint8_t                     data[MODBUS_MAX_DATA_SIZE];
        uint16_t                    crc_got;
        uint16_t                    crc_cal;
        #if defined(STM32H7)
        ALIGN_32BYTES(uint8_t       buff[MODBUS_REQ_RES_SIZE]);
        #else
        uint8_t                     buff[MODBUS_REQ_RES_SIZE];
        #endif
        uint16_t                    buff_index;
    } req;
    struct
    {
        uint8_t                     slave_address;
        uint8_t                     function_code;
        //---
        uint8_t                     exception_code;
        //--- For most messages
        uint16_t                    first_register_address;
        uint16_t                    number_of_registers;
        uint16_t                    byte_count;
        //--- write_file_record, read_file_record
        uint8_t                     data_length;
        uint8_t                     reference_type;
        uint16_t                    file_number;
        uint16_t                    record_number;
        uint16_t                    record_length;
        //---------------------
        uint8_t                     data[MODBUS_MAX_DATA_SIZE];
        uint16_t                    crc_got;
        uint16_t                    crc_cal;
        uint8_t                     buff[MODBUS_REQ_RES_SIZE];
        uint16_t                    buff_index;
    } res;
} modbus_message_t;

typedef enum
{
    WAIT_FOR_SLAVE_ADDRESS = 0,
    WAIT_FOR_FUNCTION_CODE,
    // -----------------
    WAIT_FOR_EXCEPTION_CODE,
    // -----------------
    WAIT_FOR_DATA_LENGTH,
    WAIT_FOR_REFERENCE_TYPE,
    WAIT_FOR_FILE_NUMBER,
    WAIT_FOR_RECORD_NUMBER,
    WAIT_FOR_RECORD_LENGTH,
    WAIT_FOR_RECORD_DATA,
    // -----------------
    WAIT_FOR_FIRST_REGISTER_ADDRESS,
    WAIT_FOR_NUMBER_OF_REGISTERS,
    // -----------------
    WAIT_FOR_BYTE_COUNT,
    // -----------------
    WAIT_FOR_DATA,
    // -----------------
    WAIT_FOR_CRC
} modbus_rx_state_t;

typedef enum
{
    MODBUS_DMA = 0,
    MODBUS_IT
} modbus_rx_tx_type_t;

typedef enum
{
    modmus_16bit_order_AB = 0, // default
    modmus_16bit_order_BA
} modmus_16bit_order_t;

typedef enum
{
    modmus_32bit_order_ABCD = 0, // default
    modmus_32bit_order_DCBA,
    modmus_32bit_order_BADC,
    modmus_32bit_order_CDAB
} modmus_32bit_order_t;

typedef void (* mx_uartx_init_t)    (void);
typedef void (* tx_enable_t)        (void);
typedef void (* rx_enable_t)        (void);

uint16_t modbus_crc16(const uint8_t *nData, uint16_t wLength);
void     modbus_byte_array_to_bool_array(uint8_t *bytes, uint16_t byte_count, bool *bools, uint16_t bool_count);
uint16_t modbus_bool_array_to_byte_array(bool *bools, uint16_t bool_count, uint8_t *bytes);
void     modbus_byte_array_to_u16_array(uint8_t *bytes, uint16_t byte_count, uint16_t *u16, modmus_16bit_order_t order);
void     modbus_byte_array_to_u32_array(uint8_t *bytes, uint16_t byte_count, uint32_t *u32, modmus_32bit_order_t order);
/* read_coils ************************************************************************************************************************************
+ Read the ON/OFF status of discrete outputs (DO) in the slave.
+ PLC_Address = 00001:09999 => Coil Status
+ Broadcast is not supported.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x01, 0x00, 0x13, 0x00, 0x25, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x01 (read_coils)                                                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x13} = 0x0013 = 19 => PLC_Address = 00020                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x25} = 0x0025 = 37                                                                      |
                                               | Here is an example of a request to read coils 00020~00056 (37 coils), from slave device 3       |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x01, 0x05, 0x53, 0x6B, 0x01, 0xF4, 0x1B, crc0, crc1}                          |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x01 (read_coils)                                                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x05                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 |- bit_wise           | {0x53, 0x6B, 0x01, 0xF4, 0x1B}                                                                  |
| uint8_t[byte_count]    |- One bit per coil   | 0x53 = 01010011 = 00020(1), 00021(1), 00022(0), 00023(0), 00024(1), 00025(0), 00026(1), 00027(0)|
|                        |- The LSB of the     | 0x6B = 01101011 = 00028(1), 00029(1), 00030(1), 00031(0), 00032(1), 00033(0), 00034(1), 00035(1)|
|                        |  Data[0] contains   | 0x01 = 00000001 = 00036(0), 00037(0), 00038(0), 00039(0), 00040(0), 00041(0), 00042(0), 00043(0)|
|                        |  the coil addressed | 0xF4 = 11110100 = 00044(0), 00045(0), 00046(1), 00047(0), 00048(1), 00049(1), 00050(1), 00051(1)|
|                        |  in the request.    | 0x1B = ---11011 = 00052(1), 00053(1), 00054(0), 00055(1), 00056(1), --------, --------, --------|
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* read_discrete_inputs **************************************************************************************************************************
+ Read the ON/OFF status of discrete inputs (DI) in the slave.
+ PLC_Address = 10001:19999 => Discrete input (Input Status)
+ Broadcast is not supported.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x02, 0x00, 0x64, 0x00, 0x14, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x02 (read_discrete_inputs)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x64} = 0x0064 = 100 => PLC_Address = 10101                                              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x14} = 0x0014 = 20 => PLC_Address = 10101~10120                                         |
|                        |                     | Here is an example of a request to read inputs 10101~10120 (20 inputs), from slave device 3     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x02, 0x03, 0x53, 0x6B, 0x01, 0xF4, 0x1B, crc0, crc1}                          |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x02 (read_discrete_inputs)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 |- bit_wise           | {0x53, 0x6B, 0x01}                                                                              |
| uint8_t[byte_count]    |- One bit per input  | 0x53 = 01010011 = 10101(1), 10102(1), 10103(0), 10104(0), 10105(1), 10106(0), 10107(1), 10108(0)|
|                        |- The LSB of the     | 0x6B = 01101011 = 10109(1), 10110(1), 10111(1), 10112(0), 10113(1), 10114(0), 10115(1), 10116(1)|
|                        |  Data[0] contains   | 0x01 = 00000001 = 10117(0), 10118(0), 10119(0), 10120(0), --------, --------, --------, --------|
|                        |  the input addressed|                                                                                                 |
|                        |  in the request.    |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* read_holding_registers ************************************************************************************************************************
+ Read the binary contents of holding registers in the slave.
+ PLC_Address = 40001:49999 => Holding Register
+ Broadcast is not supported.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x07, 0x03, 0x00, 0xC8, 0x00, 0x03, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x07                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x03 (read_holding_registers)                                                                   |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0xC8} = 0x00C8 = 200 => PLC_Address = 40201                                              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x03} = 0x0003 = 3 => PLC_Address = 40201~40203                                          |
|                        |                     | Here is an example of a request to read registers 40201~40203 (3 registers), from slave device 7|
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x07, 0x03, 0x06, 0x03, 0xE8, 0x01, 0xF4, 0x00, 0x0A, crc0, crc1}                    |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x07                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x03 (read_holding_registers)                                                                   |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x06                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 | SWAP16(uint16_t)[]  | {0x03, 0xE8, 0x01, 0xF4, 0x00, 0x0A}                                                            |
| uint8_t[byte_count]    |                     | {0x03E8, 0x01F4, 0x000A}                                                                        |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* read_input_registers **************************************************************************************************************************
+ Read the binary contents of input registers in the slave.
+ PLC_Address = 30001:39999 => Input Register
+ Broadcast is not supported.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x07, 0x04, 0x01, 0x2C, 0x00, 0x03, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x07                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x04 (read_input_registers)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x01, 0x2C} = 0x012C = 300 => PLC_Address = 30301                                              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x03} = 0x0003 = 3 => PLC_Address = 30301~30303                                          |
|                        |                     | Here is an example of a request to read registers 30301~30303 (3 registers), from slave device 7|
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x07, 0x04, 0x06, 0x03, 0xE8, 0x01, 0xF4, 0x00, 0x0A, crc0, crc1}                    |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x07                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x04 (read_input_registers)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x06                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 | SWAP16(uint16_t)[]  | {0x03, 0xE8, 0x01, 0xF4, 0x00, 0x0A}                                                            |
| uint8_t[byte_count]    |                     | {0x03E8, 0x01F4, 0x000A}                                                                        |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* write_single_coil *****************************************************************************************************************************
+ Forces a single coil to either ON or OFF of the discrete output (DO) status in the slave.
+ PLC_Address = 00001:09999 => Coil Status
+ When broadcast, the function forces the same coil reference in all attached slaves.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x05, 0x00, 0x95, 0xFF, 0x00, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x05 (write_single_coil)                                                                        |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x95} = 0x0095 = 149 => PLC_Address = 00150                                              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0xFF, 0x00} = 0xFF00 = ON                                                                     |
| A value of 0xFF00 requests the coil to be ON.| Here is an example of a request to force coil 150 ON in slave device 3                          |
| A value of 0x0000 requests it to be OFF.     |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
The normal res is an echo of the req.*/
/************************************************************************************************************************************************/
/* write_single_holding_register *****************************************************************************************************************
+ Presets a value into a single holding register. 
+ PLC_Address = 40001:49999 => Holding Register
+ When broadcast, the function presets the same register reference in all attached slaves.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x03, 0x06, 0x00, 0x95, 0x03, 0xE8, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x03                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x06 (write_single_holding_register)                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x95} = 0x0095 = 149 => PLC_Address = 40150                                              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x03, 0xE8} = 0x03E8 = 1000                                                                    |
|                        |                     | Here is an example of a request to preset register 1000 to 40150 in slave device 3              |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
The normal res is an echo of the req.*/
/************************************************************************************************************************************************/
/************************************************************************************************************************************************/
/* write_multiple_coils **************************************************************************************************************************
+ Forces each coil in a sequence of the discrete outputs (DO) to either ON or OFF.
+ PLC_Address = 00001:09999 => Coil Status
+ When broadcast, the function forces the same coil references in all attached slaves.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x05, 0x0F, 0x00, 0x13, 0x00, 0x0B, 0x02, 0xD1, 0x05, crc0, crc1}                    |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x05                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x0F (write_multiple_coils)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x13} = 0x0013 = 19 => PLC_Address = 00020                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x0B} = 0x000B = 11                                                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x02 = 2                                                                                        |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 |- bit_wise           | Here is a request to force a series of 11 coils starting at coil 20 in slave device 5.          |
| uint8_t[byte_count]    |- One bit per coil   | {0xD1, 0x05}                                                                                    |
|                        |- The LSB of the     | 0xD1 = 11010001 = 00020(1), 00021(0), 00022(0), 00023(0), 00024(1), 00025(0), 00026(1), 00027(1)|
|                        |  Data[0] contains   | 0x05 = 00000101 = 00028(1), 00029(0), 00030(1), --------, --------, --------, --------, --------|
|                        |  the coil addressed |                                                                                                 |
|                        |  in the request.    |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x05, 0x0F, 0x00, 0x13, 0x00, 0x0B, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x05                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x0F (write_multiple_coils)                                                                     |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x13} = 0x0013 = 19 => PLC_Address = 00020                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x0B} = 0x000B = 11                                                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* write_multiple_registers **********************************************************************************************************************
+ Presets values into a sequence of holding registers.
+ PLC_Address = 40001:49999 => Holding Register
+ When broadcast, the function presets the same register reference in all attached slaves.
req:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x05, 0x10, 0x00, 0x13, 0x00, 0x03, 0x06, 0x01, 0x64, 0x01, 0x65, 0x01, 0x66, crc0, crc1}|
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x05                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x10 (write_multiple_registers)                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x13} = 0x0013 = 19 => PLC_Address = 00020                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x03} = 0x0003 = 3                                                                       |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| byte_count             | uint8_t             | 0x06 = 6                                                                                        |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data[]                 | SWAP16(uint16_t)[]  | Here is an example of a request to preset registers 40020~40022 in slave device 5:              |
| uint8_t[byte_count]    |                     | 40020 data 0x0164                                                                               |
|                        |                     | 40021 data 0x0165                                                                               |
|                        |                     | 40022 data 0x0166                                                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+

res:
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name             | type                | Example = {0x05, 0x10, 0x00, 0x13, 0x00, 0x03, crc0, crc1}                                      |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address          | uint8_t             | 0x05                                                                                            |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code          | uint8_t             | 0x10 (write_multiple_registers)                                                                 |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| first_register_address | SWAP16(uint16_t)    | {0x00, 0x13} = 0x0013 = 19 => PLC_Address = 00020                                               |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| number_of_registers    | SWAP16(uint16_t)    | {0x00, 0x03} = 0x0003 = 3                                                                       |
+------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                    | uint16_t            |                                                                                                 |
+------------------------+---------------------+------------------------------------------------------------------------------------------------*/
/************************************************************************************************************************************************/
/* write_file_record *****************************************************************************************************************************
+ This function code is used to perform a file record write.
+ All Request Data Lengths are provided in terms of number of bytes and all Record Lengths are provided in terms of the number of 16-bit words.
+ A file is an organization of records. Each file contains 10000 records, addressed 0000 to 9999 decimal or 0X0000 to 0X270F. 
req:
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| Field Name                 | type                | Example = {0x05, 0x15, 0x0D, 0x06, 0x00, 0x04, 0x00, 0x07, 0x00, 0x03, 0x06, 0xAF, 0x04, 0xBE, 0x10, 0x0D, crc0, crc1}|
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| slave_address              | uint8_t             | 0x05                                                                                            |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| function_code              | uint8_t             | 0x15 (write_file_record)                                                                        |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| data_length                | uint8_t             | 0x0D = 13                                                                                       |
|                            | 0x09 to 0xFB        |                                                                                                 |
|                            | Number of <<bytes>> from reference_type until last byte of record_data (2 byte of crc is not in count)                |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| reference_type             | uint8_t             | 0x06 (must be specified as 6)                                                                   |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| file_number                | SWAP16(uint16_t)    | {0x00, 0x04} = 0x0004 = 4                                                                       |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| record_number              | SWAP16(uint16_t)    | {0x00, 0x07} = 0x0007 = 7                                                                       |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| record_length              | SWAP16(uint16_t)    | {0x00, 0x03} = 0x0003 = 3                                                                       |
|                            | Number of <<16-bit words>>                                                                                            |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| record_data[record_length] | SWAP16(uint16_t)[]  | {0x06AF, 0x04BE, 0x100D}                                                                        |
| uint8_t[record_length x 2] |                                                                                                                       |
| record_data[k] standardly represents in big-endial format, but if little-endian format is desired, the user can use little-endian on both sides.   |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
| crc                        | uint16_t            |                                                                                                 |
+----------------------------+---------------------+-------------------------------------------------------------------------------------------------+
The normal res is an echo of the req.*/

#ifdef __cplusplus
}
#endif

#endif
